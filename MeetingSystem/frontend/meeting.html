<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .header {
            background: #2d2d2d;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #667eea;
        }

        .meeting-title {
            font-size: 20px;
            font-weight: bold;
        }

        .leave-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .main-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: calc(100vh - 70px);
        }

        .workspace {
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            background: #2d2d2d;
            padding: 10px 20px;
            gap: 10px;
        }

        .tab-btn {
            background: transparent;
            color: #999;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-sidebar {
            background: #2d2d2d;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #3d3d3d;
        }

        .chat-header {
            padding: 15px 20px;
            background: #3d3d3d;
            font-weight: bold;
            border-bottom: 2px solid #667eea;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .message {
            background: #3d3d3d;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .message-user {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .message-content {
            color: #ddd;
        }

        .message-time {
            color: #999;
            font-size: 11px;
            margin-top: 5px;
        }

        .chat-input {
            padding: 15px 20px;
            background: #3d3d3d;
            display: flex;
            gap: 10px;
            border-top: 2px solid #4d4d4d;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #4d4d4d;
            border-radius: 8px;
            background: #2d2d2d;
            color: white;
            font-size: 14px;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .whiteboard-canvas {
            border: 2px solid #4d4d4d;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
        }

        .whiteboard-tools {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .tool-btn {
            background: #3d3d3d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .tool-btn.active {
            background: #667eea;
        }

        .notes-area {
            width: 100%;
            height: 400px;
            background: #2d2d2d;
            color: white;
            border: 2px solid #4d4d4d;
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="meeting-title" id="meeting-title">Loading...</div>
        <button class="leave-btn" onclick="leaveMeeting()">Leave Meeting</button>
    </div>

    <div class="main-area">
        <div class="workspace">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chat')">üí¨ Chat</button>
                <button class="tab-btn" onclick="switchTab('whiteboard')">üé® Whiteboard</button>
                <button class="tab-btn" onclick="switchTab('notes')">üìù Notes</button>
            </div>

            <div class="content-area">
                <div id="tab-chat" class="tab-content active">
                    <h2 style="margin-bottom: 20px;">Chat Messages</h2>
                    <div id="main-chat-messages" style="max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">No messages yet. Start the conversation!</div>
                    </div>
                </div>

                <div id="tab-whiteboard" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px;">Collaborative Whiteboard</h2>
                    <div class="whiteboard-tools">
                        <button class="tool-btn active" onclick="setTool('line')">‚úèÔ∏è Line</button>
                        <button class="tool-btn" onclick="setTool('rect')">‚¨ú Rectangle</button>
                        <button class="tool-btn" onclick="setTool('circle')">‚≠ï Circle</button>
                        <button class="tool-btn" onclick="clearWhiteboard()">üóëÔ∏è Clear</button>
                    </div>
                    <canvas id="whiteboard" class="whiteboard-canvas" width="900" height="500"></canvas>
                </div>

                <div id="tab-notes" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px;">Shared Notes</h2>
                    <textarea class="notes-area" id="notes" placeholder="Type your notes here..."></textarea>
                    <button style="margin-top: 15px; width: 200px;" onclick="saveNotes()">Save Notes</button>
                </div>
            </div>
        </div>

        <div class="chat-sidebar">
            <div class="chat-header">üí¨ Live Chat</div>
            <div class="chat-messages" id="chat-messages">
                <div class="empty-state">No messages yet</div>
            </div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="handleChatKeypress(event)">
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api/v1';
        
        // Get meeting ID from URL params FIRST, fallback to sessionStorage
        const urlParams = new URLSearchParams(window.location.search);
        const meetingIdFromUrl = urlParams.get('id');
        const meetingIdFromSession = sessionStorage.getItem('current_meeting_id');
        const meetingId = meetingIdFromUrl || meetingIdFromSession;
        
        const token = sessionStorage.getItem('token');
        const username = sessionStorage.getItem('username');
        
        console.log('=== Meeting Page Debug ===');
        console.log('Meeting ID from URL:', meetingIdFromUrl);
        console.log('Meeting ID from session:', meetingIdFromSession);
        console.log('Final Meeting ID:', meetingId);
        console.log('Token:', token ? 'Present' : 'Missing');
        console.log('Username:', username);
        console.log('========================');
        
        let currentTool = 'line';
        let isDrawing = false;

        // CRITICAL: Check for valid meetingId
        if (!token || !meetingId || meetingId === 'undefined' || meetingId === 'null') {
            console.error('Invalid session data:', { token, meetingId });
            alert('Invalid meeting session. Redirecting to lobby...');
            window.location.href = 'lobby.html';
        }

        // Set meeting title
        const meetingTitle = sessionStorage.getItem('current_meeting_title') || 'Meeting Room';
        document.getElementById('meeting-title').textContent = meetingTitle;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
        }

        // Chat functionality
        async function loadMessages() {
            try {
                console.log(`Fetching messages for meeting ${meetingId}`);
                const response = await fetch(`${API_URL}/meetings/${meetingId}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                console.log('Messages response:', data);

                if (data.success) {
                    displayMessages(data.messages);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function displayMessages(messages) {
            if (typeof messages === 'string') {
                messages = JSON.parse(messages);
            }

            const chatDiv = document.getElementById('chat-messages');
            const mainChatDiv = document.getElementById('main-chat-messages');
            
            if (!messages || messages.length === 0) {
                chatDiv.innerHTML = '<div class="empty-state">No messages yet</div>';
                mainChatDiv.innerHTML = '<div class="empty-state">No messages yet</div>';
                return;
            }

            const html = messages.map(msg => {
                const isMe = msg.username === username;
                const displayName = isMe ? 'You' : msg.username;
                const userColor = isMe ? '#10b981' : '#667eea';
                
                return `
                    <div class="message">
                        <div class="message-user" style="color: ${userColor};">${displayName}</div>
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${new Date(msg.timestamp * 1000).toLocaleTimeString()}</div>
                    </div>
                `;
            }).join('');

            chatDiv.innerHTML = html;
            mainChatDiv.innerHTML = html;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            
            if (!content) return;

            try {
                console.log(`Sending message to meeting ${meetingId}`);
                const response = await fetch(`${API_URL}/meetings/${meetingId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();
                console.log('Send message response:', data);

                if (data.success) {
                    input.value = '';
                    await loadMessages();
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Whiteboard functionality
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        let startX, startY;

        async function loadWhiteboard() {
            try {
                console.log(`Fetching whiteboard for meeting ${meetingId}`);
                const response = await fetch(`${API_URL}/meetings/${meetingId}/whiteboard/elements`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                console.log('Whiteboard response:', data);

                if (data.success) {
                    renderWhiteboard(data.elements);
                }
            } catch (error) {
                console.error('Error loading whiteboard:', error);
            }
        }

        function renderWhiteboard(elements) {
            if (typeof elements === 'string') {
                try {
                    elements = JSON.parse(elements);
                } catch (e) {
                    console.error('Error parsing whiteboard elements:', e);
                    return;
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!elements || elements.length === 0) {
                return;
            }

            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;

            elements.forEach(elem => {
                ctx.beginPath();

                if (elem.element_type === 0) {
                    ctx.moveTo(elem.x1, elem.y1);
                    ctx.lineTo(elem.x2, elem.y2);
                } else if (elem.element_type === 1) {
                    ctx.rect(elem.x1, elem.y1, elem.x2 - elem.x1, elem.y2 - elem.y1);
                } else if (elem.element_type === 2) {
                    const radius = Math.sqrt((elem.x2 - elem.x1) ** 2 + (elem.y2 - elem.y1) ** 2);
                    ctx.arc(elem.x1, elem.y1, radius, 0, 2 * Math.PI);
                }

                ctx.stroke();
            });
        }

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        });

        canvas.addEventListener('mouseup', async (e) => {
            if (!isDrawing) return;
            isDrawing = false;

            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            const elementType = currentTool === 'line' ? 0 : currentTool === 'rect' ? 1 : 2;

            try {
                console.log(`Drawing on meeting ${meetingId}`);
                const response = await fetch(`${API_URL}/meetings/${meetingId}/whiteboard/draw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        element_type: elementType,
                        x1: Math.floor(startX),
                        y1: Math.floor(startY),
                        x2: Math.floor(endX),
                        y2: Math.floor(endY)
                    })
                });

                if (response.ok) {
                    await loadWhiteboard();
                }
            } catch (error) {
                console.error('Error drawing:', error);
            }
        });

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function clearWhiteboard() {
            if (!confirm('Clear the entire whiteboard for everyone?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/meetings/${meetingId}/whiteboard/clear`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    await loadWhiteboard();
                }
            } catch (error) {
                console.error('Error clearing whiteboard:', error);
            }
        }

        function saveNotes() {
            const notes = document.getElementById('notes').value;
            sessionStorage.setItem(`meeting_${meetingId}_notes`, notes);
            alert('Notes saved locally!');
        }

        function leaveMeeting() {
            window.location.href = 'lobby.html';
        }

        let messageInterval;
        let whiteboardInterval;

        function startPolling() {
            messageInterval = setInterval(loadMessages, 5000);
            whiteboardInterval = setInterval(loadWhiteboard, 5000);
        }

        function stopPolling() {
            clearInterval(messageInterval);
            clearInterval(whiteboardInterval);
        }

        // Pause polling when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Tab hidden, stopping polling');
                stopPolling();
            } else {
                console.log('Tab visible, resuming polling');
                loadMessages();
                loadWhiteboard();
                startPolling();
            }
        });

        // Start polling on page load
        startPolling();

        // Load saved notes
        const savedNotes = sessionStorage.getItem(`meeting_${meetingId}_notes`);
        if (savedNotes) {
            document.getElementById('notes').value = savedNotes;
        }
    </script>
</body>
</html>